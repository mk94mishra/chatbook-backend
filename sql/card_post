1. tbl_card_post  -- view

create or replace view tbl_card_post as (
with
al as (select post_id, count(id) as count_like from tbl_action where type='like' group by post_id),
ac as (select post_id, count(id) as count_comment from tbl_action where type='comment' group by post_id)

select 
p.*,
DATE_PART('day', AGE(CURRENT_TIMESTAMP,p.created_at)) AS ageing,
u.username,u.gender,u.profile_pic_url,u.designation_id, u.rating, u.lat, u.long,
ocom.name as community_name,
ocat.name as category_name,
al.count_like,
ac.count_comment
from tbl_post as p
left join tbl_user as u on p.user_id=u.id
left join tbl_option as ocom on p.community_id=ocom.id
left join tbl_option as ocat on p.category_id=ocat.id
left join al on p.id=al.post_id
left join ac on p.id=ac.post_id
where p.is_active=true
)

id
created_at
description
media
community_id
community_name
category_id
category_name
user_id
username
profile_pic_url
gender
designation_id
rating
ageing
lat
long
count_like
count_comment
is_active
remark


2. tbl_card_post_private -- after login

with
al as (select id,post_id,created_at from tbl_action where type='like' and user_id={logged_in_user}),
ac as (select array_agg(id) as id, post_id, max(created_at) as created_atfrom tbl_action where type='comment' and user_id={logged_in_user} group by post_id),
abo as (select id,post_id ,created_at from tbl_action where type='bookmark' and user_id={logged_in_user}),
asp as (select id,post_id ,created_at from tbl_action where type='spam' and user_id={logged_in_user}),
ab1 as (select id, user_id, user_id_blocked_id from tbl_action  where type='block' and user_id={logged_in_user}),
ab2 as (select id, user_id, user_id_blocked_id from tbl_action  where type='block' and user_id_blocked_id ={logged_in_user})

select 
p.*,
al.id as action_id_like,al.created_at as created_at_like,
ac.id as action_id_comment,ac.created_at as created_at_comment,
abo.id as action_id_bookmark,abo.created_at as created_at_bookmark,
asp.id as action_id_spam, asp.created_at as created_at_spam,
ab1.id as action_id_block,
ab2.id as action_id_block_me
st_distance(st_makepoint(p.lat,p.long), st_makepoint({self_user_lat},{self_user_long})) as distance
from tbl_card_post as p
left join al on p.id=al.post_id
left join ac on p.id=ac.post_id
left join abo on p.id=abo.post_id
left join asp on p.id=asp.post_id
left join ab1 on p.user_id=ab1.user_id_blocked_id
left join ab2 on p.user_id=ab2.user_id

  

id
created_at
description
media
community_id
community_name
category_id
category_name
user_id
username
profile_pic_url
gender
designation_id
rating
ageing
lat
long
count_like
count_comment
is_active
remark


action_id_like
created_at_like
action_id_comment
created_at_comment
action_id_bookmark
created_at_bookmark
action_id_spam
created_at_spam
action_id_block
action_id_block_me
distance


3. base filter

is_active=true
action_id_block isnull
action_id_block_me isnull

community_id = user.community_id